<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BRRRR Deal Analyzer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <div id="app" class="max-w-6xl mx-auto px-4 py-10">
    <header class="flex items-center justify-between mb-8">
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-teal-300">BRRRR Deal Analyzer</p>
        <h1 class="text-3xl font-bold mt-2">Model your numbers with confidence</h1>
        <p class="text-slate-400">Enter the deal assumptions below to run the FastAPI calculator.</p>
      </div>
      <div class="flex items-center gap-3 bg-slate-900/70 border border-slate-800 rounded-xl px-4 py-3 shadow-lg shadow-teal-500/5">
        <span class="h-3 w-3 rounded-full bg-emerald-400 animate-pulse"></span>
        <div>
          <p class="text-sm font-semibold text-emerald-300">API target</p>
          <p class="text-xs text-slate-400">https://brrrrdealanalyzer.onrender.com/analyzeDeal</p>
        </div>
      </div>
    </header>

    <main class="grid lg:grid-cols-3 gap-6">
      <section class="lg:col-span-2 space-y-6">
        <div class="bg-slate-900/60 border border-slate-800 rounded-2xl shadow-xl shadow-teal-500/5 overflow-hidden">
          <div class="bg-gradient-to-r from-teal-500/10 via-transparent to-indigo-500/10 px-6 py-4 border-b border-slate-800">
            <h2 class="text-lg font-semibold">1. Buy &amp; Rehab</h2>
            <p class="text-sm text-slate-400">Acquisition costs and hard money assumptions.</p>
          </div>
          <div class="p-6 grid md:grid-cols-2 gap-4">
            <template v-for="field in sections.buyRehab" :key="field.key">
              <label class="flex flex-col gap-2 text-sm font-medium text-slate-200">
                {{ field.label }}
                <div class="relative">
                  <input
                    v-model="form[field.key]"
                    :type="field.type || 'number'"
                    :step="field.step || 'any'"
                    :min="field.min"
                    :required="field.required"
                    :placeholder="field.placeholder"
                    class="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-4 py-3 text-slate-100 focus:outline-none focus:ring-2 focus:ring-teal-500/60"
                  />
                  <span v-if="field.suffix" class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-400">{{ field.suffix }}</span>
                </div>
                <span class="text-xs text-slate-500">{{ field.helper }}</span>
              </label>
            </template>
            <label class="flex items-center gap-3 bg-slate-950/50 border border-slate-800 rounded-xl px-4 py-3">
              <input type="checkbox" v-model="form.use_HM_for_rehab" class="h-4 w-4 text-teal-500 focus:ring-teal-500 border-slate-700 bg-slate-900 rounded" />
              <div>
                <p class="font-semibold">Use Hard Money for Rehab</p>
                <p class="text-xs text-slate-400">Toggle rehab funding with hard money</p>
              </div>
            </label>
          </div>
        </div>

        <div class="bg-slate-900/60 border border-slate-800 rounded-2xl shadow-xl shadow-teal-500/5 overflow-hidden">
          <div class="bg-gradient-to-r from-amber-500/10 via-transparent to-pink-500/10 px-6 py-4 border-b border-slate-800">
            <h2 class="text-lg font-semibold">2. Refinance</h2>
            <p class="text-sm text-slate-400">Refi expectations after renovations.</p>
          </div>
          <div class="p-6 grid md:grid-cols-2 gap-4">
            <template v-for="field in sections.refi" :key="field.key">
              <label class="flex flex-col gap-2 text-sm font-medium text-slate-200">
                {{ field.label }}
                <div class="relative">
                  <input
                    v-model="form[field.key]"
                    :type="field.type || 'number'"
                    :step="field.step || 'any'"
                    :min="field.min"
                    :required="field.required"
                    :placeholder="field.placeholder"
                    class="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-4 py-3 text-slate-100 focus:outline-none focus:ring-2 focus:ring-amber-500/60"
                  />
                  <span v-if="field.suffix" class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-400">{{ field.suffix }}</span>
                </div>
                <span class="text-xs text-slate-500">{{ field.helper }}</span>
              </label>
            </template>
          </div>
        </div>

        <div class="bg-slate-900/60 border border-slate-800 rounded-2xl shadow-xl shadow-teal-500/5 overflow-hidden">
          <div class="bg-gradient-to-r from-emerald-500/10 via-transparent to-cyan-500/10 px-6 py-4 border-b border-slate-800">
            <h2 class="text-lg font-semibold">3. Rent &amp; Expenses</h2>
            <p class="text-sm text-slate-400">Income and ongoing operating costs.</p>
          </div>
          <div class="p-6 grid md:grid-cols-2 gap-4">
            <template v-for="field in sections.rentExpenses" :key="field.key">
              <label class="flex flex-col gap-2 text-sm font-medium text-slate-200">
                {{ field.label }}
                <div class="relative">
                  <input
                    v-model="form[field.key]"
                    :type="field.type || 'number'"
                    :step="field.step || 'any'"
                    :min="field.min"
                    :required="field.required"
                    :placeholder="field.placeholder"
                    class="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-4 py-3 text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
                  />
                  <span v-if="field.suffix" class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-400">{{ field.suffix }}</span>
                </div>
                <span class="text-xs text-slate-500">{{ field.helper }}</span>
              </label>
            </template>
          </div>
        </div>

        <div class="flex justify-end gap-3">
          <button @click="resetForm" class="px-4 py-3 rounded-xl border border-slate-800 bg-slate-900 text-slate-200 hover:border-slate-700 transition">Reset</button>
          <button @click="submitForm" class="px-6 py-3 rounded-xl bg-gradient-to-r from-teal-500 to-emerald-500 text-slate-950 font-semibold shadow-lg shadow-teal-500/30 hover:shadow-teal-500/60 transition flex items-center gap-2">
            <span v-if="loading" class="h-4 w-4 border-2 border-slate-900 border-t-transparent rounded-full animate-spin"></span>
            Run Analysis
          </button>
        </div>
      </section>

      <aside class="space-y-4">
        <div class="bg-slate-900/60 border border-slate-800 rounded-2xl shadow-xl shadow-teal-500/5 p-6">
          <h3 class="text-lg font-semibold mb-4">Results</h3>
          <div v-if="error" class="mb-4 rounded-xl border border-rose-500/40 bg-rose-500/10 text-rose-100 px-4 py-3 text-sm">
            {{ error }}
          </div>
          <div v-if="result" class="space-y-3">
            <div v-for="(value, key) in displayResults" :key="key" class="flex items-center justify-between bg-slate-950/50 border border-slate-800 rounded-xl px-4 py-3">
              <span class="text-sm text-slate-300 capitalize">{{ key.replace(/_/g, ' ') }}</span>
              <span class="font-semibold">{{ value }}</span>
            </div>
          </div>
          <div v-else class="text-sm text-slate-500">Run the analysis to see outputs such as cash flow, DSCR, cash-on-cash, ROI, equity, and net profit.</div>
        </div>

        <div class="bg-gradient-to-br from-slate-900 via-slate-900/80 to-slate-950 border border-slate-800 rounded-2xl p-5 shadow-lg shadow-emerald-500/5">
          <h4 class="font-semibold mb-2">Guidance</h4>
          <ul class="text-sm text-slate-400 space-y-1 list-disc list-inside">
            <li>Values marked required (*) align with ellipsis fields in the API model.</li>
            <li>Fields labeled ($000s) expect values in thousands; the API converts them.</li>
            <li>Percentages are entered as whole numbers (e.g., 75 for 75%).</li>
          </ul>
        </div>
      </aside>
    </main>
  </div>

  <script>
    const { createApp } = Vue;

    const requiredFields = {
      arv_in_thousands: true,
      purchase_price_in_thousands: true,
      down_payment: true,
      Months_until_refi: true,
      HML_interest_rate: true,
      ltv_as_precent: true,
      interest_rate: true,
      rent: true
    };

    const defaults = {
      rehab_cost_in_thousands: 0,
      closing_costs_buy_in_thousands: 0,
      use_HM_for_rehab: false,
      HML_points: 0,
      closing_cost_refi_in_thousands: 0,
      loan_term_years: 30,
      vacancy_percent: 0,
      property_managment_fee_precentages_from_rent: 0,
      maintenance_percent: 0,
      capex_percent_of_rent: 0,
      taxes: 0,
      insurance: 0,
      hoa: 0
    };

    createApp({
      data() {
        return {
          form: {
            arv_in_thousands: '',
            purchase_price_in_thousands: '',
            rehab_cost_in_thousands: defaults.rehab_cost_in_thousands,
            closing_costs_buy_in_thousands: defaults.closing_costs_buy_in_thousands,
            use_HM_for_rehab: defaults.use_HM_for_rehab,
            down_payment: '',
            HML_points: defaults.HML_points,
            Months_until_refi: '',
            HML_interest_rate: '',
            closing_cost_refi_in_thousands: defaults.closing_cost_refi_in_thousands,
            loan_term_years: defaults.loan_term_years,
            ltv_as_precent: '',
            interest_rate: '',
            rent: '',
            vacancy_percent: defaults.vacancy_percent,
            property_managment_fee_precentages_from_rent: defaults.property_managment_fee_precentages_from_rent,
            maintenance_percent: defaults.maintenance_percent,
            capex_percent_of_rent: defaults.capex_percent_of_rent,
            taxes: defaults.taxes,
            insurance: defaults.insurance,
            hoa: defaults.hoa
          },
          loading: false,
          error: '',
          result: null,
          sections: {
            buyRehab: [
              { key: 'purchase_price_in_thousands', label: 'Purchase Price ($000s) *', placeholder: 'e.g., 250', helper: 'Acquisition price in thousands', required: true },
              { key: 'rehab_cost_in_thousands', label: 'Rehab Cost ($000s)', placeholder: 'e.g., 40', helper: 'Renovation budget in thousands', required: false },
              { key: 'closing_costs_buy_in_thousands', label: 'Closing Costs (Buy) ($000s)', placeholder: 'e.g., 5', helper: 'Closing costs when purchasing (thousands)', required: false },
              { key: 'down_payment', label: 'Down Payment % *', placeholder: 'e.g., 20', helper: 'Down payment percentage for hard money', required: true, suffix: '%' },
              { key: 'HML_points', label: 'Hard Money Points %', placeholder: 'e.g., 2', helper: 'Points charged by hard money lender', required: false, suffix: '%' },
              { key: 'HML_interest_rate', label: 'Hard Money Interest Rate % *', placeholder: 'e.g., 12', helper: 'Interest rate during HML period', required: true, suffix: '%' },
            ],
            refi: [
              { key: 'arv_in_thousands', label: 'After Repair Value (ARV) ($000s) *', placeholder: 'e.g., 325', helper: 'Expected ARV in thousands', required: true },
              { key: 'ltv_as_precent', label: 'LTV % *', placeholder: 'e.g., 75', helper: 'Loan-to-value percentage for refi', required: true, suffix: '%' },
              { key: 'Months_until_refi', label: 'Months until Refi *', placeholder: 'e.g., 6', helper: 'Months between purchase and refi', required: true },
              { key: 'closing_cost_refi_in_thousands', label: 'Refi Closing Costs ($000s)', placeholder: 'e.g., 4', helper: 'Closing costs during refinance (thousands)', required: false },
              { key: 'interest_rate', label: 'Long-term Interest Rate % *', placeholder: 'e.g., 6.5', helper: 'Rate for DSCR/long-term loan', required: true, suffix: '%' },
              { key: 'loan_term_years', label: 'Loan Term (Years)', placeholder: 'e.g., 30', helper: 'Amortization period', required: false },
            ],
            rentExpenses: [
              { key: 'rent', label: 'Monthly Rent *', placeholder: 'e.g., 2500', helper: 'Expected monthly rent', required: true, prefix: '$' },
              { key: 'taxes', label: 'Taxes (Annual)', placeholder: 'e.g., 4200', helper: 'Annual property taxes', required: false },
              { key: 'insurance', label: 'Insurance (Annual)', placeholder: 'e.g., 1200', helper: 'Annual insurance premium', required: false },
              { key: 'hoa', label: 'HOA (Monthly)', placeholder: 'e.g., 150', helper: 'Monthly HOA dues', required: false },
              { key: 'vacancy_percent', label: 'Vacancy %', placeholder: 'e.g., 5', helper: 'Percentage of rent reserved for vacancy', required: false, suffix: '%' },
              { key: 'maintenance_percent', label: 'Maintenance %', placeholder: 'e.g., 8', helper: 'Maintenance reserve as % of rent', required: false, suffix: '%' },
              { key: 'capex_percent_of_rent', label: 'CapEx %', placeholder: 'e.g., 5', helper: 'Capital expenditures % of rent', required: false, suffix: '%' },
              { key: 'property_managment_fee_precentages_from_rent', label: 'Property Management %', placeholder: 'e.g., 8', helper: 'Management fee as % of rent', required: false, suffix: '%' },
            ]
          }
        };
      },
      computed: {
        displayResults() {
          if (!this.result) return {};
          const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
          const transformValue = (val) => {
            if (val === -1) return '∞';
            if (val === -2) return '-∞';
            if (typeof val === 'number') return formatter.format(val);
            return val;
          };
          return Object.fromEntries(
            Object.entries(this.result).map(([key, val]) => [key, Array.isArray(val) ? val.join(', ') : transformValue(val)])
          );
        }
      },
      methods: {
        resetForm() {
          this.form = { ...defaults, ...{
            arv_in_thousands: '',
            purchase_price_in_thousands: '',
            down_payment: '',
            Months_until_refi: '',
            HML_interest_rate: '',
            ltv_as_precent: '',
            interest_rate: '',
            rent: ''
          }};
          this.error = '';
          this.result = null;
        },
        async submitForm() {
          this.error = '';
          this.result = null;

          const payload = { ...this.form };
          Object.keys(defaults).forEach((key) => {
            if (payload[key] === '' || payload[key] === null || payload[key] === undefined) {
              payload[key] = defaults[key];
            }
          });

          // Align with backend expectations: ensure both long-form field names used in the
          // FastAPI handler and the Pydantic model are present in the payload.
          payload.closing_costs_buy = payload.closing_costs_buy_in_thousands;
          payload.annual_property_taxes = payload.taxes;
          payload.annual_insurance = payload.insurance;
          payload.montly_hoa = payload.hoa;

          for (const key of Object.keys(requiredFields)) {
            if (requiredFields[key] && (payload[key] === '' || payload[key] === null || payload[key] === undefined)) {
              this.error = 'Please complete all required fields before submitting.';
              return;
            }
          }

          this.loading = true;
          try {
            const response = await fetch('https://brrrrdealanalyzer.onrender.com/analyzeDeal', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            const data = await response.json();
            if (!response.ok) {
              throw new Error(data.detail || 'Request failed');
            }

            this.result = data;
          } catch (err) {
            this.error = err.message || 'Something went wrong. Please try again.';
          } finally {
            this.loading = false;
          }
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
